# =============================================================================
# Agriculture - Corn IR Estimation Configuration
# =============================================================================
# Uses IR zarr data from: {data_base}/agriculture/corn/ir/ir.zarr
#
# Agricultural yields have an inverted-U (concave) response:
# - Optimal temperature range for growth
# - Yields decrease at temperature extremes
# - Concavity constraint ensures beta <= 0
#
# Gamma (income elasticity) estimated via Fixed Effects:
#   y_it = γ * log(gdppc_it) + μ_{region × temp_bin} + θ_year + ε_it
#
# Regional estimation fits per-region damage functions:
#   y_normalized = intercept + α * T + β * T²  (with β ≤ 0)
# Note: Includes intercept to match R reference script
#

run:
  name: "agriculture_corn_ir"
  description: "Corn yield response estimation from IR data"
  # Results saved in: /project/.../agriculture/corn/results/ir/
  output_dir: "/project/cil/home_dirs/scadavidsanchez/projects/flex-damages-data/agriculture/corn/results/ir"

sector:
  name: "agriculture"
  subsector: "corn"

data:
  # Path to IR zarr (set via --data-base argument or override here)
  dataset_dir: "/project/cil/home_dirs/scadavidsanchez/projects/flex-damages-data/agriculture/corn/ir/ir.zarr"
  source_format: "zarr"

  columns:
    # Outcome variable
    y: "log_yield_impact"

    # Income variable for gamma regression (will be log-transformed)
    x1: "loggdppc"

    # Temperature variable for FE binning
    x2: "temperature_anomaly"

    # Temperature variable for functional form
    x: "temperature_anomaly"

    # Population weights
    w: "pop"

    # Identifiers
    region: "region"
    year: "year"

  # Aggregation settings (if needed)
  aggregation:
    dims: ["region", "year", "ssp", "rcp", "model"]
    method: "mean"
    weights: "pop"

estimation:
  # Functional form for regional damage functions
  # Includes intercept to match R reference script: lm(y ~ delta_temp + tas_preind2)
  functional_form:
    type: "explicit"
    formula: "intercept + alpha * x + beta * x**2"

  # Global estimation settings (gamma)
  global:
    method: "fixed_effects"
    # Temperature bin width for FE grouping
    # Groups: region × floor(temp_anomaly / temperature_bins)
    # Smaller = more flexible, larger = more robust
    temperature_bins: 0.5

  # Regional estimation settings (alpha/beta per region)
  regional:
    aggregation_level: "impact_region"
    backend: "pandas"
    # Minimum observations required per region
    min_observations: 10

    # Normalization method for income adjustment (matches R reference code)
    # "ratio" (default, R-style): y_norm = y / exp(income)^gamma
    #   => Prediction: pred = (intercept + alpha*T + beta*T²) * exp(income)^gamma
    # "additive": y_norm = y - gamma * income
    #   => Prediction: pred = (intercept + alpha*T + beta*T²) + gamma * income
    normalization_method: "ratio"

    # Whether to include intercept in functional form
    include_intercept: true

  # Parameter constraints
  # Concavity: ensures damage function is inverted-U shaped (beta ≤ 0)
  # This is appropriate for agriculture where yields decline at temperature extremes
  constraints:
    - type: "formula"
      expression: "beta <= 0"

execution:
  mode: "local"
  n_workers: 1
  test_mode: false
  test_sample_size: 100
  test_seed: 42
